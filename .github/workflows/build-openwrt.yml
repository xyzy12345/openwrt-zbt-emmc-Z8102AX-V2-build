name: Build OpenWrt for ZBT-Z8102AX (eMMC Base)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: 1. Checkout OpenWrt source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v24.10.4

    - name: 2. [CORE] Find and patch device configuration
      run: |
        cd ${{ github.workspace }}
        
        echo "=== 搜索包含 zbtlink_zbt-z8102ax 的 .mk 文件 ==="
        # 搜索整个 target/linux/mediatek 目录
        FILE_PATH=$(grep -r "zbtlink_zbt-z8102ax" target/linux/mediatek/ --include="*.mk" | head -1 | cut -d: -f1)
        
        if [ -z "$FILE_PATH" ]; then
          echo "未找到包含 zbtlink_zbt-z8102ax 的 .mk 文件，尝试搜索 mt798x.mk"
          # 尝试查找 mt798x.mk
          if [ -f "target/linux/mediatek/image/mt798x.mk" ]; then
            FILE_PATH="target/linux/mediatek/image/mt798x.mk"
            echo "找到 mt798x.mk 文件"
          else
            echo "=== 列出所有可能的 .mk 文件 ==="
            find target/linux/mediatek/image/ -name "*.mk" -type f
            echo "=== 查看 mt7981b-zbtlink-zbt-z8102ax.dts 中的定义 ==="
            head -50 target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax.dts
            echo "❌ 找不到设备配置文件，请检查路径"
            exit 1
          fi
        fi
        
        echo "✅ 找到配置文件: $FILE_PATH"
        
        # 查看文件内容确认
        echo "=== 查看文件中 zbtlink_zbt-z8102ax 相关定义 ==="
        grep -A 20 -B 5 "define Device/zbtlink_zbt-z8102ax" "$FILE_PATH" || echo "未找到定义，查看文件开头"
        head -30 "$FILE_PATH"
        
        # 备份原文件
        cp "$FILE_PATH" "${FILE_PATH}.backup"
        
        # 修正eMMC启动参数
        sed -i '/define Device\/zbtlink_zbt-z8102ax/,/^endef/ {
          /KERNEL_CMDLINE/d
          /^endef/i \  KERNEL_CMDLINE := earlycon=uart8250,mmio32,0x11002000 console=ttyS0,115200n8 root=PARTLABEL=rootfs rootfstype=squashfs,f2fs
        }' "$FILE_PATH"
        
        echo "✅ eMMC启动参数已注入到 $FILE_PATH"
        
        # 验证修改
        echo "=== 验证修改后的定义 ==="
        grep -A 15 "define Device/zbtlink_zbt-z8102ax" "$FILE_PATH"

    - name: 3. Update and install feeds
      run: |
        cd ${{ github.workspace }}
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 4. Apply minimal configuration
      run: |
        cd ${{ github.workspace }}
        # 生成默认配置
        make defconfig
        
        # 应用精简配置 - 注意：根据官方固件路径，可能是 filogic
        echo "CONFIG_TARGET_mediatek=y" > .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_zbt-z8102ax=y" >> .config
        
        # eMMC基础支持
        echo "CONFIG_PACKAGE_kmod-mmc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-f2fs=y" >> .config
        
        # 基本系统
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-proto-ppp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        
        # 网络基础
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall4=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        
        # 应用配置
        make defconfig

    - name: 5. Download packages
      run: |
        cd ${{ github.workspace }}
        make download -j$(nproc)
      timeout-minutes: 60

    - name: 6. Build firmware
      run: |
        cd ${{ github.workspace }}
        make -j$(nproc) V=s
      timeout-minutes: 120

    - name: 7. Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-zbt-z8102ax-emmc-base
        path: ${{ github.workspace }}/bin/targets/mediatek/filogic/
        retention-days: 30
