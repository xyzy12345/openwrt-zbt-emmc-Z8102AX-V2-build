name: Build OpenWrt for ZBT-Z8102AX (eMMC+5G)

on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - '.github/workflows/build-openwrt.yml'
      - 'custom-config/**'    # å¯æ·»åŠ è‡ªå®šä¹‰é…ç½®ç›®å½•
    branches: [ main ]

env:
  TARGET: mediatek
  SUBTARGET: mt7981
  PROFILE: zbtlink_zbt-z8102ax

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: 1. æ£€å‡ºOpenWrtæºç 
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: master
        path: openwrt
        
    - name: 2. è¿›å…¥å·¥ä½œç›®å½•
      run: cd openwrt
      
    - name: 3. [æ ¸å¿ƒ] æ³¨å…¥eMMCå¯åŠ¨å‚æ•°
      run: |
        # å¤‡ä»½åŸé…ç½®æ–‡ä»¶
        cp target/linux/mediatek/image/mt7981.mk target/linux/mediatek/image/mt7981.mk.backup
        
        # æ›¿æ¢å†…æ ¸å‘½ä»¤è¡Œï¼ŒæŒ‡å®šeMMCåˆ†åŒº
        sed -i '/define Device\/zbtlink_zbt-z8102ax/,/^endef/ {
          /KERNEL_CMDLINE/d
          /^endef/i \  KERNEL_CMDLINE := earlycon=uart8250,mmio32,0x11002000 console=ttyS0,115200n8 root=PARTLABEL=rootfs rootfstype=squashfs,f2fs
        }' target/linux/mediatek/image/mt7981.mk
        
        echo "âœ… eMMCå¯åŠ¨å‚æ•°å·²æ³¨å…¥ï¼šroot=PARTLABEL=rootfs"
        
    - name: 4. æ›´æ–°å¹¶å®‰è£…è½¯ä»¶æº
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: 5. åº”ç”¨è‡ªå®šä¹‰é…ç½®
      run: |
        # ç”Ÿæˆæœ€å°åŒ–é…ç½®
        make defconfig
        
        # åº”ç”¨æˆ‘ä»¬çš„å®šåˆ¶é…ç½®
        cat >> .config << 'EOF'
# ç›®æ ‡è®¾å¤‡
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_mt7981=y
CONFIG_TARGET_mediatek_mt7981_DEVICE_zbtlink_zbt-z8102ax=y

# ===== eMMCå­˜å‚¨æ”¯æŒ =====
CONFIG_PACKAGE_kmod-mmc=y
CONFIG_PACKAGE_kmod-mtk-mmc=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-f2fs=y
CONFIG_PACKAGE_f2fs-tools=y
CONFIG_PACKAGE_f2fsck=y
CONFIG_PACKAGE_block-mount=y

# ===== USB 5Gæ¨¡ç»„å…¨å¥—æ”¯æŒ =====
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-net=y

# QMIåè®®ï¼ˆé«˜é€šæ¨¡ç»„å¦‚RM500Qï¼‰
CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y

# MBIMåè®®ï¼ˆéƒ¨åˆ†5Gæ¨¡ç»„ï¼‰
CONFIG_PACKAGE_kmod-usb-net-cdc-mbim=y

# RNDISåè®®ï¼ˆå¤‡ç”¨ï¼‰
CONFIG_PACKAGE_kmod-usb-net-rndis=y

# USBä¸²å£æ”¯æŒ
CONFIG_PACKAGE_kmod-usb-serial=y
CONFIG_PACKAGE_kmod-usb-serial-option=y
CONFIG_PACKAGE_kmod-usb-serial-wwan=y

# ===== 5Gç®¡ç†å·¥å…· =====
CONFIG_PACKAGE_uqmi=y          # QMIå‘½ä»¤è¡Œå·¥å…·
CONFIG_PACKAGE_modemmanager=y  # è‡ªåŠ¨è¯†åˆ«ç®¡ç†æ¨¡ç»„
CONFIG_PACKAGE_comgt-ncm=y     # NCMåè®®æ”¯æŒ
CONFIG_PACKAGE_comgt=y

# ===== ç½‘ç»œåŸºç¡€ =====
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall4=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd-ujail=y

# ===== Luciç®¡ç†ç•Œé¢ =====
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-proto-modemmanager=y  # 5Gæ¥å£æ”¯æŒ
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y

# ===== å®ç”¨å·¥å…· =====
CONFIG_PACKAGE_usbutils=y      # lsusbç­‰å·¥å…·
CONFIG_PACKAGE_uboot-envtools=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_tcpdump=y

# ä¸­æ–‡æ”¯æŒï¼ˆå¯é€‰ï¼‰
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
EOF
        
        # ä½¿é…ç½®ç”Ÿæ•ˆ
        make defconfig
        
    - name: 6. å¯é€‰ï¼šäº¤äº’å¼é…ç½®ï¼ˆæ³¨é‡Šæ‰åˆ™ä¸ºå…¨è‡ªåŠ¨ï¼‰
      run: |
        # å¦‚éœ€è‡ªå®šä¹‰åŒ…ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹è¡Œ
        # make menuconfig
        echo "è·³è¿‡äº¤äº’é…ç½®ï¼Œä½¿ç”¨é¢„è®¾é…ç½®"
        
    - name: 7. ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…
      run: make download -j$(nproc)
      timeout-minutes: 90
      
    - name: 8. å¼€å§‹ç¼–è¯‘å›ºä»¶
      run: make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
      timeout-minutes: 180
      
    - name: 9. ä¸Šä¼ å›ºä»¶åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-zbt-z8102ax-emmc-5g
        path: |
          openwrt/bin/targets/mediatek/mt7981/*.bin
          openwrt/bin/targets/mediatek/mt7981/*.manifest
          openwrt/build.log
        retention-days: 30
        
    - name: 10. ç¼–è¯‘æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      if: success()
      run: |
        echo "ğŸ‰ å›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
        echo "åœ¨ArtifactsåŒºåŸŸä¸‹è½½å›ºä»¶ï¼šopenwrt-zbt-z8102ax-emmc-5g"
