name: Build OpenWrt for ZBT-Z8102AX (eMMC Base)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: 1. Checkout OpenWrt source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v24.10.4  # ✅ 注意：必须是 v24.10.4，不是 openwrt-24.10.4！

    - name: 2. [CORE] Patch for eMMC version
      run: |
        # 进入源码目录
        cd ${{ github.workspace }}
        
        # 先检查目录结构
        echo "=== 检查目标目录结构 ==="
        find target/linux/mediatek/ -name "*zbt*" 2>/dev/null || echo "未找到zbt相关文件"
        echo "=== 检查filogic目录 ==="
        ls -la target/linux/mediatek/filogic/ 2>/dev/null || echo "filogic目录不存在"
        echo "=== 检查mt7981文件 ==="
        find target/linux/ -name "mt7981.mk" 2>/dev/null || echo "未找到mt7981.mk"
        
        # 根据找到的文件路径进行修改
        if [ -f "target/linux/mediatek/filogic/image/mt7981.mk" ]; then
          FILE_PATH="target/linux/mediatek/filogic/image/mt7981.mk"
        elif [ -f "target/linux/mediatek/mt7981/image/mt7981.mk" ]; then
          FILE_PATH="target/linux/mediatek/mt7981/image/mt7981.mk"
        else
          echo "❌ 找不到mt7981.mk文件"
          exit 1
        fi
        
        echo "找到配置文件: $FILE_PATH"
        
        # 备份原文件
        cp "$FILE_PATH" "${FILE_PATH}.backup"
        
        # 修正eMMC启动参数
        sed -i '/define Device\/zbtlink_zbt-z8102ax/,/^endef/ {
          /KERNEL_CMDLINE/d
          /^endef/i \  KERNEL_CMDLINE := earlycon=uart8250,mmio32,0x11002000 console=ttyS0,115200n8 root=PARTLABEL=rootfs rootfstype=squashfs,f2fs
        }' "$FILE_PATH"
        
        echo "✅ eMMC启动参数已注入到 $FILE_PATH"

    # ... 后续步骤保持不变 ...
